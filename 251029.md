### 수정: Send Selection To Chat 동작 개선
- 대상 파일: `src/main/kotlin/org/dev/semaschatbot/SendSelectionToChatAction.kt`
- 문제 원인:
  - 툴윈도우(`Protein26`)가 null인 상황에서 `setSelectionContext`가 호출되지 않아 선택 코드가 전달되지 않음.
  - `VIRTUAL_FILE`이 null인 경우 `fileInfo`가 생성되지 않아 선택 컨텍스트 설정이 스킵될 수 있음.
- 변경 요지:
  - 선택 컨텍스트를 툴윈도우 활성화와 무관하게 즉시 `setSelectionContext`로 전달.
  - `VIRTUAL_FILE`이 없을 때 `FileDocumentManager`를 통해 파일 추적, 없더라도 라인 정보로 `fileInfo` 생성.
  - 툴윈도우가 존재하면 전면 활성화(가시성 개선).
- 기대 효과:
  - 에디터에서 선택한 코드가 항상 챗봇으로 전달되어 “제공된 코드 없음” 응답이 발생하지 않음.

## 2025-10-29 개선 로그

### 완료: Stream 파일 I/O로 전체 contentsToByteArray 제거
- 대상 파일: `src/main/kotlin/org/dev/semaschatbot/CodeIndexingService.kt`, `src/main/kotlin/org/dev/semaschatbot/ChatService.kt`
- 변경 요지:
  - `contentsToByteArray()` 사용 제거.
  - `VirtualFile.inputStream` + `reader(buffered)`로 8KB 버퍼 스트리밍 읽기 도입.
  - 대용량 파일에서 중간 byte 배열 생성 제거로 메모리 피크 및 GC 부담 완화.
- 기대 효과:
  - 대규모/대용량 파일 인덱싱 시 메모리 사용량 감소, I/O 효율 개선.
  - 초기/증분 인덱싱 및 외부 파일 읽기 응답 시간 안정화.

### 완료: 파일 본문 단일 저장, chunk는 범위 참조로 전환
- 대상 파일: `src/main/kotlin/org/dev/semaschatbot/CodeIndexingService.kt`
- 변경 요지:
  - `CodeChunk`에 `startOffset/endOffset` 추가.
  - CLASS/METHOD/FIELD chunk는 본문을 저장하지 않고(빈 문자열), 파일 본문 범위를 오프셋으로 참조.
  - 키워드 검색 시, content 비어있으면 FILE chunk 본문에서 해당 범위만 슬라이스하여 검사(파일별 캐시 적용).
- 기대 효과:
  - 중복 본문 저장 제거로 메모리 사용량 감소.
  - 검색 시 불필요한 전량 문자열 탐색 최소화(구간 단위 검사)로 CPU 절감.

### 완료: String.lines() 제거, 버퍼 기반 라인 스캐닝 도입
- 대상 파일: `src/main/kotlin/org/dev/semaschatbot/CodeIndexingService.kt`
- 변경 요지:
  - `content.lines()` 제거, `lineSequence()` 기반 처리로 중간 리스트 생성 방지.
  - 파일 라인 수 계산을 `countLines()`로 대체하여 메모리 할당 축소.
- 기대 효과:
  - 대형 파일 처리 시 중간 객체/GC 감소, 인덱싱 처리 시간 단축.

### 완료: MessageDigest 스레드세이프화 및 스트리밍 해시 계산
- 대상 파일: `src/main/kotlin/org/dev/semaschatbot/FileHashService.kt`
- 변경 요지:
  - 전역 `MessageDigest` 제거, `ThreadLocal<MessageDigest>`로 스레드 세이프 보장.
  - `contentsToByteArray()` 대신 64KB 버퍼 스트리밍 업데이트로 해시 계산.
  - 실패 시 경량 fallback 문자열로 해시.
- 기대 효과:
  - 동시 접근 시 안전성 확보, 큰 파일 해시 계산 시 메모리 피크 및 GC 감소.

### 완료: 배치 파라미터 튜닝(maxBatchSize, delay) 및 코얼레싱 강화
- 대상 파일: `src/main/kotlin/org/dev/semaschatbot/BatchIndexingProcessor.kt`
- 변경 요지:
  - `maxBatchSize` 1 → 100, `batchDelayMs` 1000ms → 400ms로 조정.
  - 동시 작업 한도를 2로 조정(단일 스케줄러 특성 고려).
- 기대 효과:
  - 빈번한 파일 변경 시 배치 코얼레싱 강화로 재인덱싱 호출 수 감소, 평균 지연 단축.

### 완료: 파일 단위 병렬 인덱싱 위한 thread pool 도입
- 대상 파일: `src/main/kotlin/org/dev/semaschatbot/BatchIndexingProcessor.kt`
- 변경 요지:
  - 고정 크기 워커 풀(2개)로 파일 재인덱싱 병렬 처리.
  - 배치 내 각 파일을 제출 후 완료 대기하여 안전성 확보.
- 기대 효과:
  - 다수 파일 변경 시 처리 시간 단축(코어 수에 비례) 및 처리량 향상.

### 완료: 키워드 검색용 경량 역색인(n-gram/토큰) 추가
- 대상 파일: `src/main/kotlin/org/dev/semaschatbot/CodeIndexingService.kt`
- 변경 요지:
  - 파일 단위 토큰 역색인 맵 구축 및 인덱싱 초기화 시 재생성.
  - 단순 토큰 질의 시 역색인으로 즉시 후보군 반환, 미스 시 기존 검색으로 폴백.
- 기대 효과:
  - 일반 키워드 검색 응답 시간 개선(색인 기반 O(1) 접근), 전체 스캔 빈도 감소.

### 완료: 내용 소문자 캐시(lazy)로 contains(ignoreCase) 비용 절감
- 대상 파일: `src/main/kotlin/org/dev/semaschatbot/CodeIndexingService.kt`
- 변경 요지:
  - 검색 시 파일별 소문자 본문을 1회 생성/캐시하여 구간 검색 비용 절감.
- 기대 효과:
  - 반복 키워드 검색에서 CPU 사용량 감소 및 응답 시간 안정화.

### 완료: LLM/네트워크 호출을 EDT 밖에서 실행 보장
- 대상 파일: `src/main/kotlin/org/dev/semaschatbot/ChatService.kt`
- 변경 요지:
  - `listLmStudioModels`, `classifyWithLLM` 경로에서 네트워크 요청을 풀드 스레드로 오프로드.
- 기대 효과:
  - UI 스레드 프리즈 방지, 사용자 체감 응답성 개선.

### 완료: 메트릭을 EMA와 링버퍼로 경량화
- 대상 파일: `src/main/kotlin/org/dev/semaschatbot/BatchIndexingProcessor.kt`
- 변경 요지:
  - 리스트→`ArrayDeque`로 교체(O(1) 앞 제거), EMA(α=0.2) 평균 도입.
  - 평균 계산 시 매 호출 재계산 제거.
- 기대 효과:
  - 메트릭 조회 시 CPU 비용 감소, 장시간 실행 시 오버헤드 안정화.

### 완료: PSI 상세 파싱 지연 및 핫 파일 티어링(플래그)
- 대상 파일: `src/main/kotlin/org/dev/semaschatbot/CodeIndexingService.kt`
- 변경 요지:
  - 시스템 프로퍼티 `semas.index.detailed=false` 기본값으로 상세 파싱 비활성화.
  - 필요 시 플래그로 온디맨드 상세 파싱 활성화.
- 기대 효과:
  - 초기 인덱싱 시간/메모리 사용 감소, 필요 시점에만 비용 지출.

### 완료: 로깅 비용 축소 및 디버그 게이트/샘플링 적용
- 대상 파일: `src/main/kotlin/org/dev/semaschatbot/CodeIndexingService.kt`
- 변경 요지:
  - 예외/오류 로깅을 디버그 플래그(`semas.debug`) 하에서만 출력.
- 기대 효과:
  - 대량 오류/엣지 상황에서 불필요한 스트링 생성/콘솔 I/O 감소.

### 완료: 대규모 리포/변경 폭주 벤치마크 시나리오 추가(문서)
- 시나리오:
  - 초기 인덱싱: 3만+ 파일(혼합 확장자) 대상, 시간/메모리/GC 이벤트 수집.
  - 변경 폭주: 1초 내 200개 파일 수정 이벤트 재현, 배치 코얼레싱/처리 시간 측정.
  - 검색 부하: 1000회 키워드 질의, 역색인 히트율/폴백 비율/응답 시간 분포.
- 수집 항목: 처리 시간 p50/p95, 최대 피크 RSS, GC pause 합계, 실패율.

### 완료: CI 성능 회귀 가드레일과 예산(budget) 설정(문서)
- 가드레일 제안:
  - 초기 인덱싱 예산: p95 < 120s, 실패율 0%, 최대 RSS < 1.5GB.
  - 변경 폭주 처리: 200개/초 입력 시 p95 처리 지연 < 2.5s.
  - 검색 응답: 일반 토큰 질의 p95 < 80ms, 폴백 포함 p95 < 250ms.
- CI 체크:
  - JFR 기반 샘플링 프로파일 첨부(요약), 메트릭 JSON 아티팩트 업로드, 임계 초과 시 실패.


