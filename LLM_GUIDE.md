# LLM 입력 분류 및 프롬프트 생성 가이드

## 1. 입력 분류(classifyInput)

### 분류 목적
- 사용자의 입력 의도를 파악하여 적절한 LLM 프롬프트 및 처리 로직을 선택
- 최적의 컨텍스트와 응답 형식을 제공하여 정확하고 효율적인 AI 응답 생성

### 분류 방식

#### 1) LLM 기반 사전 분류 (우선순위 1)
- **목적**: LLM의 이해 능력을 활용하여 입력 의도를 정확하게 파악
- **시스템 프롬프트**: 분류 기준을 명확히 안내하여 정확한 분류 유도
- **출력 형식**: "NEW_SOURCE", "RAG_QUESTION", "GENERAL_QUESTION" 중 하나의 토큰만 반환하도록 강제
- **예시 systemPrompt**:
  ```
  당신은 입력의 의도를 분류하는 분류기입니다.
  아래 세 가지 중 하나만 출력하세요. 다른 말은 절대 하지 마세요.
  NEW_SOURCE  |  RAG_QUESTION  |  GENERAL_QUESTION

  분류 기준:
  - NEW_SOURCE: 새 파일/클래스/함수/컴포넌트 생성이나 새로운 기능 추가 요청
  - RAG_QUESTION: 현재 프로젝트 코드/파일/함수/경로/구현에 대해 묻는 질문
  - GENERAL_QUESTION: 프로젝트 특정 코드 맥락 없이 일반 지식/조언/설명

  출력 형식: 위 토큰 중 정확히 하나만. 공백/마크다운/설명 불가.
  ```
- **폴백 처리**: LLM 응답이 없거나 실패 시 휴리스틱(키워드/패턴) 분류로 자동 전환

#### 2) 휴리스틱(키워드/패턴) 분류 (우선순위 2)
- **목적**: LLM 분류 실패 시 빠르고 안정적인 분류 제공
- **주요 키워드/패턴**:
  - **코드베이스 관련 질문 키워드**: "어떻게", "어디서", "무엇", "언제", "왜", "how", "where", "what", "when", "why", "함수", "메서드", "클래스", "변수", "필드", "구현", "작동", "동작", "처리", "사용", "프로젝트", "코드", "파일", "로직", "explain", "show", "find", "search"
  - **질문형 패턴**: `\?$`, `\?\\s*$`, `^어떻게`, `^어디`, `^무엇`, `^언제`, `^왜`, `^how`, `^where`, `^what`, `^when`, `^why`
- **분류 로직**:
  - 코드베이스 관련 키워드 또는 질문형 패턴이 있으면 → `RAG_QUESTION`
  - 그 외의 경우 → `GENERAL_QUESTION`

### 분류 결과 (UserInputType)

#### 전체 타입 목록
```kotlin
enum class UserInputType {
    GENERAL_QUESTION,           // 일반 질문 (프로젝트 맥락 없음)
    RAG_QUESTION,              // RAG 기반 질문 (코드베이스 관련)
    NEW_SOURCE,                // 신규 소스 작성 요청
    INSTRUCTION,               // 코드 수정/개선 지시
    CURSOR_CODE_GENERATION,    // 커서 위치 코드 생성
    EXTERNAL_FILE_EDIT         // 외부 파일 수정
}
```

#### 타입별 설명
- **GENERAL_QUESTION**: 프로젝트 코드 맥락 없이 일반 지식/조언/설명을 요청하는 질문
- **RAG_QUESTION**: 프로젝트 코드/파일/함수/경로/구현에 대한 질문 (RAG 검색 활용)
- **NEW_SOURCE**: 새 파일/클래스/함수/컴포넌트 생성이나 새로운 기능 추가 요청
- **INSTRUCTION**: 선택된 코드에 대한 수정/개선 지시 (예: "이 함수에 주석 추가해줘")
- **CURSOR_CODE_GENERATION**: 현재 커서 위치에 코드를 생성하는 요청
- **EXTERNAL_FILE_EDIT**: 특정 파일 경로를 지정하여 수정하는 요청

---

## 2. 프롬프트 생성 로직

### 분류별 프롬프트 특징

#### 1) RAG_QUESTION
- **목적**: 프로젝트 코드베이스를 기반으로 한 정확한 답변 제공
- **컨텍스트 구성**:
  - 선택된 코드가 있으면 먼저 포함 (최대 2000자)
  - 관련 코드 청크 최대 5개를 RAG 검색으로 추출
  - 각 청크는 파일명, 타입(CLASS/METHOD/FIELD), 위치(라인 범위), 시그니처, 내용 포함
- **프롬프트 템플릿**:
  ```
  아래 제공된 프로젝트 코드 컨텍스트와 사용자 질문을 바탕으로 답변하세요. 출력은 반드시 다음 Markdown 템플릿만 사용합니다.

  템플릿:
  ✅ 질문 요약 : {사용자 질문 요점}
  ✅ 응답 : {응답 내용 (1000자 이내 요약, 정리)}
  ✅ 출처 : {출처 (파일명, 라인 위치)}

  규칙:
  - 한국어로만 작성합니다.
  - '질문 요약'에는 사용자의 질문 핵심을 1~2문장으로 요약합니다.
  - '응답'은 1000자 이내로 간결하게 요약하고, 필요시 불릿을 사용할 수 있습니다.
  - '출처'는 아래 참조 코드의 파일명과 라인 범위를 쉼표로 나열합니다. 형식: 파일명:시작라인-끝라인
  - 참조 코드가 없거나 라인 정보를 알 수 없으면 '해당 없음'으로 표기합니다.
  - 템플릿 외의 여분 텍스트는 출력하지 않습니다.
  ```

#### 2) NEW_SOURCE
- **목적**: 신규 소스 코드 생성 시 프로젝트 컨텍스트와 스타일을 반영
- **컨텍스트 구성**:
  - 선택된 참조 코드가 있으면 포함 (최대 2000자)
  - 관련 코드 청크 최대 5개를 RAG 검색으로 추출하여 프로젝트 스타일 파악
- **프롬프트 템플릿**:
  ```
  아래 제공된 프로젝트 코드 컨텍스트와 사용자 질문을 바탕으로 답변하세요. 출력은 반드시 다음 Markdown 템플릿만 사용합니다.

  템플릿:
  ✅ 질문 요약 : {사용자 질문 요점}
  ✅ 응답 : {응답 내용 (1000자 이내 요약, 정리)}
  ✅ 출처 : {출처 (파일명, 라인 위치)}

  규칙:
  - 한국어로만 작성합니다.
  - '질문 요약'에는 사용자의 질문 핵심을 1~2문장으로 요약합니다.
  - '응답'은 1000자 이내로 간결하게 요약하고, 필요시 불릿을 사용할 수 있습니다.
  - '출처'는 아래 참조 코드의 파일명과 라인 범위를 쉼표로 나열합니다. 형식: 파일명:시작라인-끝라인
  - 참조 코드가 없거나 라인 정보를 알 수 없으면 '해당 없음'으로 표기합니다.
  - 템플릿 외의 여분 텍스트는 출력하지 않습니다.
  ```

#### 3) INSTRUCTION
- **목적**: 선택된 코드의 수정/개선 지시 처리
- **전제 조건**: 선택된 코드가 반드시 있어야 함 (없으면 오류 메시지 반환)
- **프롬프트 템플릿**:
  ```
  사용자가 선택한 코드를 수정/개선해달라고 요청했습니다.

  선택된 코드 (파일: {파일명}):
  ```
  {선택된 코드}
  ```

  사용자 요청: {사용자 입력}

  아래 지시사항을 따라 수정된 코드를 제공하세요:

  1. 원본 코드를 분석하고 사용자의 요청을 이해하세요.
  2. 수정된 코드를 다음 형식으로 제공하세요:
     [Modified]
     ```코드언어
     수정된 코드 전체
     ```
  3. 코드 블록 내에 수정된 코드만 포함하고, 설명이나 주석은 코드 블록 밖에 작성하세요.
  4. 사용자의 요청을 정확히 반영하여 코드를 수정하세요.
  5. 코드 스타일과 구조는 원본과 일관성을 유지하세요.
  6. 한국어로 설명을 제공하세요.

  주의사항:
  - 반드시 [Modified] 태그로 시작해야 합니다.
  - 코드 블록은 수정된 코드 전체를 포함해야 합니다.
  ```

#### 4) GENERAL_QUESTION
- **목적**: 일반 지식/조언/설명 요청 처리
- **컨텍스트**: 코드 컨텍스트 없이 일반 지식 기반으로 답변
- **프롬프트 템플릿**:
  ```
  아래 제공된 컨텍스트와 사용자 질문을 바탕으로 답변하세요. 출력은 반드시 다음 Markdown 템플릿만 사용합니다.

  템플릿:
  ✅ 질문 요약 : {사용자 질문 요점}
  ✅ 응답 : {응답 내용 (1000자 이내 요약, 정리)}
  ✅ 출처 : {출처 (파일명, 라인 위치) 또는 '해당 없음'}

  규칙:
  - 한국어로만 작성합니다.
  - '질문 요약'에는 사용자의 질문 핵심을 1~2문장으로 요약합니다.
  - '응답'은 1000자 이내로 간결하게 요약하고, 필요시 불릿을 사용할 수 있습니다.
  - '출처'는 프로젝트 코드와 관련이 없으므로 '해당 없음'으로 표기합니다.
  - 템플릿 외의 여분 텍스트는 출력하지 않습니다.
  ```

---

## 3. RAG 검색 시스템

### 검색 알고리즘
- **관련 코드 청크 검색**: `CodeIndexingService.searchRelevantCode(query, maxResults)`
- **검색 범위**: 프로젝트 전체 인덱싱된 코드 조각 (클래스, 메서드, 필드, 파일)
- **검색 방식**:
  - 파일명 매칭
  - 시그니처 매칭
  - 코드 내용 매칭
  - 역색인 기반 토큰 검색 (단순 토큰 질의인 경우)

### 검색 결과 활용
- 최대 5개의 관련 코드 청크를 프롬프트에 포함
- 각 청크는 파일명, 타입, 위치(라인 범위), 시그니처, 내용 포함
- 코드 내용은 최대 1000자로 제한하여 토큰 효율성 확보

---

## 4. 요약

### 입력 분류 시스템
- **2단계 분류**: LLM 기반 사전 분류 → 휴리스틱 분류 (폴백)
- **6가지 입력 타입**: GENERAL_QUESTION, RAG_QUESTION, NEW_SOURCE, INSTRUCTION, CURSOR_CODE_GENERATION, EXTERNAL_FILE_EDIT
- **자동 의도 파악**: 사용자 입력을 자동으로 분석하여 최적의 처리 방식 선택

### 프롬프트 생성 전략
- **타입별 맞춤 프롬프트**: 각 입력 타입에 최적화된 프롬프트 템플릿 제공
- **컨텍스트 기반 응답**: RAG 검색을 통한 관련 코드 자동 포함
- **일관된 출력 형식**: Markdown 템플릿을 통한 구조화된 응답 형식

### 핵심 원칙
- **성능 최적화**: 토큰 사용량 최소화 (코드 내용 길이 제한, 관련 코드만 포함)
- **정확성 향상**: RAG 기반 코드 검색으로 프로젝트 맥락 반영
- **사용자 경험**: 명확한 템플릿과 규칙으로 일관된 응답 제공

---

(이 가이드는 ChatService.kt 기준 자동화된 분석 결과입니다.)
