# 검색 기능 테스트 가이드

## 📋 목차

1. [환경 설정](#환경-설정)
2. [인덱싱 준비](#인덱싱-준비)
3. [기본 검색 테스트](#기본-검색-테스트)
4. [고급 검색 테스트](#고급-검색-테스트)
5. [성능 테스트](#성능-테스트)
6. [문제 해결](#문제-해결)

---

## 🔧 환경 설정

### 1. 플러그인 빌드 및 실행

```bash
# 프로젝트 빌드
./gradlew buildPlugin

# 또는 IntelliJ IDEA에서 직접 실행
# Run Configuration에서 "Plugin" 실행
```

### 2. LM Studio 서버 설정

1. **LM Studio 실행**: 로컬 LLM 서버가 실행 중이어야 합니다.
2. **API URL 확인**: 기본값은 `http://localhost:1234`입니다.
3. **모델 로드**: 챗봇에 사용할 모델을 로드합니다.

### 3. 테스트 프로젝트 준비

- **권장**: 실제 개발 중인 프로젝트 사용
- **최소 요구사항**:
  - Java/Kotlin 파일 여러 개
  - 다양한 크기의 파일 (작은 파일, 큰 파일)
  - 클래스, 메서드, 필드가 포함된 파일

---

## 📂 인덱싱 준비

### 1. 프로젝트 인덱싱 시작

1. **IntelliJ IDEA 실행**
2. **Tool Window 열기**: `View` → `Tool Windows` → `Protein26` (또는 하단 도구창에서 선택)
3. **인증**: API 키 입력 (필요한 경우)
4. **인덱싱 시작**: 
   - 인증 후 자동으로 인덱싱이 시작되거나
   - 프로젝트 루트에서 우클릭 → "Index Project" (있는 경우)

### 2. 인덱싱 상태 확인

챗봇 창에서 다음과 같은 메시지를 확인:

```
✅ 인증이 완료되었습니다! 자동으로 프로젝트 인덱싱을 시작합니다.
🔍 프로젝트 파일을 스캔하고 있습니다...
📂 지원되는 파일 확장자: java, kt, js, ts, vue, sql, xml, yml, yaml, json, css
⚙️ PSI 트리를 분석하여 코드 구조를 파악합니다...
✅ 프로젝트 인덱싱이 완료되었습니다!
📊 인덱싱 통계:
  • 전체 코드 조각: XXX
  • 파일: XX
  • 클래스: XX
  • 메서드: XXX
  • 필드: XX
```

### 3. 인덱싱 통계 확인

채팅창에서 다음 명령으로 통계 확인:

```
인덱싱 통계 보여줘
```

또는 Tools 메뉴에서:
- `Tools` → `Show Indexing Statistics`

---

## 🔍 기본 검색 테스트

### 테스트 1: 메서드명으로 검색

**목적**: 특정 메서드를 찾을 수 있는지 확인

**절차**:
1. 채팅창에 메서드명 입력 (예: `saveCnslBefDiagInfo`)
2. 질문 입력: `"saveCnslBefDiagInfo 함수에 대해 설명해줘"`
3. 결과 확인:
   - ✅ 해당 메서드 코드가 포함되어야 함
   - ✅ 파일 경로와 라인 번호가 정확해야 함
   - ✅ 메서드의 실제 코드 내용이 포함되어야 함

**예상 결과**:
```
✅ 질문 요약 : saveCnslBefDiagInfo 함수에 대한 설명 요청
✅ 응답 : [메서드 설명]
✅ 출처 : CnslBefDiagService.java:10-50
```

### 테스트 2: 클래스명으로 검색

**목적**: 특정 클래스를 찾을 수 있는지 확인

**절차**:
1. 채팅창에 클래스명 입력 (예: `UserService`)
2. 질문 입력: `"UserService 클래스는 어떤 기능을 하는가?"`
3. 결과 확인:
   - ✅ 클래스 코드가 포함되어야 함
   - ✅ 클래스의 메서드 목록이 언급되어야 함

### 테스트 3: 키워드로 검색

**목적**: 특정 키워드가 포함된 코드를 찾을 수 있는지 확인

**절차**:
1. 채팅창에 키워드 입력 (예: `@Transactional`, `@Autowired`)
2. 질문 입력: `"@Transactional 어노테이션이 사용된 메서드를 찾아줘"`
3. 결과 확인:
   - ✅ 해당 어노테이션이 사용된 메서드들이 나와야 함
   - ✅ 여러 파일의 결과가 나올 수 있음

### 테스트 4: 파일명으로 검색

**목적**: 특정 파일을 찾을 수 있는지 확인

**절차**:
1. 채팅창에 파일명 입력 (예: `UserController.java`)
2. 질문 입력: `"UserController 파일의 주요 기능은?"`
3. 결과 확인:
   - ✅ 해당 파일의 코드가 포함되어야 함
   - ✅ 파일의 주요 클래스/메서드가 설명되어야 함

---

## 🎯 고급 검색 테스트

### 테스트 5: 선택된 코드 기반 검색

**목적**: 사용자가 선택한 코드에 대해 질문할 수 있는지 확인

**절차**:
1. 에디터에서 코드 선택 (예: 메서드 전체)
2. 우클릭 → `Send Selection to Chat`
3. 채팅창 확인:
   - ✅ 선택된 코드 미리보기가 표시되어야 함
   - ✅ 파일 정보가 표시되어야 함
4. 질문 입력: `"이 코드를 리팩토링해줘"` 또는 `"이 코드 설명해줘"`
5. 결과 확인:
   - ✅ 선택된 코드가 프롬프트에 포함되어야 함
   - ✅ 선택된 코드를 기반으로 답변이 생성되어야 함

**콘솔 로그 확인**:
```
[ChatService] sendChatRequestToLLM 호출
[ChatService] selectedCode 상태: 있음 (XXX자)
[ChatService] 선택된 코드가 프롬프트에 포함되어 있는지: true
```

### 테스트 6: 복합 검색 쿼리

**목적**: 여러 조건을 포함한 복잡한 검색

**절차**:
1. 복합 질문 입력 (예: `"UserService에서 save 메서드를 사용하는 곳을 찾아줘"`)
2. 결과 확인:
   - ✅ UserService 클래스 정보
   - ✅ save 메서드 정보
   - ✅ 관련된 다른 코드들

### 테스트 7: 코드 수정 요청

**목적**: INSTRUCTION 타입 검색 및 코드 수정

**절차**:
1. 에디터에서 수정할 코드 선택
2. 우클릭 → `Send Selection to Chat`
3. 질문 입력: `"이 코드를 개선해줘"` 또는 `"이 메서드에 에러 처리를 추가해줘"`
4. 결과 확인:
   - ✅ `[Modified]` 태그가 포함된 응답
   - ✅ 수정된 코드가 코드 블록으로 제공
   - ✅ Diff 창이 자동으로 표시되어야 함

**콘솔 로그 확인**:
```
[ChatService] INSTRUCTION 타입 처리: 선택된 코드 길이=XXX자
[ChatService] INSTRUCTION 응답 완료, 파싱 시작
[ChatService] handleInstructionResponse: 원본 코드 길이=XXX자, 수정된 코드 길이=XXX자
```

---

## ⚡ 성능 테스트

### 테스트 8: 검색 속도 측정

**목적**: 검색 성능 확인

**절차**:
1. **대용량 프로젝트 준비**: 100개 이상의 파일이 있는 프로젝트
2. **인덱싱 완료 대기**: 인덱싱 완료 메시지 확인
3. **검색 시간 측정**:
   - 채팅창에 질문 입력 시점 기록
   - 응답이 완전히 받을 때까지 시간 측정
4. **다양한 검색 패턴 테스트**:
   - 단순 키워드: `"save"`
   - 복합 질문: `"UserService의 save 메서드는 어떻게 동작하나?"`
   - 긴 질문: `"프로젝트에서 트랜잭션 처리는 어떻게 구현되어 있나?"`

**예상 성능**:
- 단순 검색: 1-3초
- 복합 검색: 3-5초
- LLM 응답 시간은 모델에 따라 다름

### 테스트 9: 메모리 사용량 확인

**목적**: Chunking 최적화 효과 확인

**절차**:
1. **IntelliJ IDEA 메모리 모니터링**:
   - `Help` → `Diagnostic Tools` → `Memory Usage`
2. **인덱싱 전 메모리 확인**
3. **인덱싱 후 메모리 확인**
4. **비교**:
   - 큰 파일(500줄 이상)이 많은 경우
   - 이전 방식 대비 메모리 사용량 감소 확인

**예상 결과**:
- 대용량 파일 기준 메모리 사용량 **70-80% 감소**
- 세부 chunk만 사용하는 경우 메모리 효율 향상

### 테스트 10: 검색 정확도 확인

**목적**: 검색 결과의 정확성 평가

**테스트 케이스**:

#### 케이스 1: 정확한 메서드명 검색
- 질문: `"saveCnslBefDiagInfo 함수를 찾아줘"`
- 기대 결과: 해당 메서드가 정확히 찾아져야 함
- 평가: ✅ 정확히 찾음 / ❌ 못 찾음 / ⚠️ 관련 코드만 찾음

#### 케이스 2: 부분 매칭 검색
- 질문: `"save 관련 함수들을 찾아줘"`
- 기대 결과: save로 시작하는 여러 메서드들이 나와야 함
- 평가: 관련성 높은 순으로 정렬되어야 함

#### 케이스 3: 의미 기반 검색
- 질문: `"사용자 정보를 저장하는 함수는?"`
- 기대 결과: saveUser, createUser 등 관련 메서드들이 나와야 함
- 평가: 벡터 검색의 효과 확인

---

## 🔧 문제 해결

### 문제 1: 검색 결과가 없음

**증상**: 질문에 대해 관련 코드를 찾지 못함

**원인 확인**:
1. 인덱싱이 완료되었는지 확인
2. 검색 대상 파일이 인덱싱되었는지 확인
3. 콘솔 로그 확인:
   ```
   [ChatService] searchRelevantCode 호출
   [ChatService] 전체 chunk 수: XXX
   ```

**해결 방법**:
- 프로젝트 재인덱싱: `Tools` → `Force Reindexing`
- 파일 확장자 확인: java, kt, js, ts 등 지원 확장자 확인
- 파일 경로 확인: build/, target/, node_modules/ 등 제외 경로 확인

### 문제 2: 선택된 코드가 프롬프트에 포함되지 않음

**증상**: Send Selection to Chat 후 질문했는데 코드가 전달되지 않음

**원인 확인**:
1. 콘솔 로그 확인:
   ```
   [SendSelectionToChat] 선택된 텍스트: ...
   [ChatService] setSelectionContext 호출: 파일=..., 코드 길이=XXX자
   [ChatService] sendChatRequestToLLM 호출
   [ChatService] selectedCode 상태: 있음 (XXX자)
   [ChatService] 선택된 코드가 프롬프트에 포함되어 있는지: true
   ```

**해결 방법**:
- `selectedCode 상태: 없음`이면 Send Selection to Chat을 다시 실행
- `선택된 코드가 프롬프트에 포함되어 있는지: false`이면 입력 타입 분류 확인
- 입력 타입이 `INSTRUCTION`이 아닌 경우 수정 관련 키워드 포함 확인

### 문제 3: 검색 속도가 느림

**증상**: 검색에 10초 이상 소요

**원인 확인**:
1. 인덱싱된 chunk 수 확인
2. LLM 모델 응답 속도 확인
3. 네트워크 지연 확인

**해결 방법**:
- 큰 프로젝트의 경우 경로별 인덱싱 사용
- LLM 모델 변경 (더 빠른 모델 사용)
- 검색 범위 제한 (특정 경로만 검색)

### 문제 4: 검색 결과가 부정확함

**증상**: 관련 없는 코드가 결과로 나옴

**원인 확인**:
1. chunk content가 비어있는지 확인
2. 검색 키워드가 너무 일반적인지 확인

**해결 방법**:
- 더 구체적인 키워드 사용
- 파일명이나 클래스명 포함
- 프로젝트 재인덱싱

---

## 📊 테스트 체크리스트

### 기본 기능 테스트
- [ ] 메서드명으로 검색 가능
- [ ] 클래스명으로 검색 가능
- [ ] 키워드로 검색 가능
- [ ] 파일명으로 검색 가능

### 고급 기능 테스트
- [ ] 선택된 코드 기반 검색 가능
- [ ] 복합 검색 쿼리 처리 가능
- [ ] 코드 수정 요청 (INSTRUCTION) 처리 가능
- [ ] 응답에 출처 정보 포함

### 성능 테스트
- [ ] 검색 속도가 적절함 (< 5초)
- [ ] 메모리 사용량이 적절함
- [ ] 대용량 프로젝트에서도 작동함

### 정확도 테스트
- [ ] 정확한 메서드명 검색 가능
- [ ] 부분 매칭 검색 가능
- [ ] 의미 기반 검색 가능
- [ ] 관련성 높은 순으로 정렬됨

---

## 🧪 테스트 시나리오 예제

### 시나리오 1: 새 프로젝트에서 검색 테스트

```markdown
1. 새 프로젝트 생성 또는 기존 프로젝트 열기
2. 인덱싱 시작 및 완료 대기
3. 다음 질문들을 순차적으로 테스트:

질문 1: "프로젝트의 주요 클래스는 무엇인가?"
질문 2: "[특정 메서드명] 함수를 찾아줘"
질문 3: "트랜잭션 처리는 어떻게 되어 있나?"
질문 4: 코드 선택 후 "이 코드를 개선해줘"
```

### 시나리오 2: 대용량 프로젝트 테스트

```markdown
1. 100개 이상의 파일이 있는 프로젝트 준비
2. 인덱싱 시작 및 완료 대기
3. 메모리 사용량 확인
4. 다양한 검색 패턴으로 테스트
5. 성능 측정 (검색 시간)
```

### 시나리오 3: 검색 정확도 테스트

```markdown
1. 알려진 함수/클래스 목록 작성
2. 각 항목에 대해 검색 테스트
3. 정확도 기록:
   - 정확히 찾음: ✅
   - 관련 코드만 찾음: ⚠️
   - 못 찾음: ❌
4. 정확도 계산: (✅ 개수 / 전체 개수) × 100%
```

---

## 📝 테스트 결과 기록 템플릿

```markdown
## 테스트 일자: YYYY-MM-DD

### 환경 정보
- 프로젝트: [프로젝트명]
- 파일 수: [XX개]
- 인덱싱된 chunk 수: [XXX개]
- LLM 모델: [모델명]

### 테스트 결과

#### 기본 검색 테스트
| 테스트 항목 | 결과 | 비고 |
|------------|------|------|
| 메서드명 검색 | ✅/❌ | |
| 클래스명 검색 | ✅/❌ | |
| 키워드 검색 | ✅/❌ | |
| 파일명 검색 | ✅/❌ | |

#### 고급 검색 테스트
| 테스트 항목 | 결과 | 비고 |
|------------|------|------|
| 선택 코드 검색 | ✅/❌ | |
| 복합 검색 | ✅/❌ | |
| 코드 수정 요청 | ✅/❌ | |

#### 성능 테스트
| 항목 | 측정값 | 목표값 | 결과 |
|------|--------|--------|------|
| 평균 검색 시간 | X초 | < 5초 | ✅/❌ |
| 메모리 사용량 | XX MB | - | - |
| 인덱싱 시간 | X초 | - | - |

#### 정확도 테스트
| 테스트 케이스 | 정확도 | 비고 |
|--------------|--------|------|
| 정확한 메서드명 | XX% | |
| 부분 매칭 | XX% | |
| 의미 기반 | XX% | |

### 발견된 문제
1. [문제 설명]
   - 해결 방법: [해결 방법]

### 개선 제안
1. [개선 제안 내용]
```

---

## 🎯 빠른 테스트 명령어

채팅창에서 바로 테스트할 수 있는 질문들:

### 기본 검색
```
"프로젝트의 주요 클래스는?"
"[메서드명] 함수를 찾아줘"
"@Transactional 어노테이션 사용되는 곳 찾아줘"
```

### 고급 검색
```
코드 선택 → "이 코드 설명해줘"
코드 선택 → "이 코드를 개선해줘"
코드 선택 → "이 메서드에 로깅 추가해줘"
```

### 통계 확인
```
"인덱싱 통계 보여줘"
"프로젝트에 몇 개의 메서드가 있나?"
```

---

## 💡 팁

1. **디버깅 모드 활성화**: 
   - VM 옵션에 `-Dsemas.debug=true` 추가
   - 상세한 로그 확인 가능

2. **콘솔 로그 확인**:
   - IntelliJ IDEA 하단의 "Run" 또는 "Debug" 탭에서 로그 확인
   - `[ChatService]`, `[SendSelectionToChat]` 등의 태그로 필터링

3. **인덱싱 상태 확인**:
   - Tools 메뉴에서 "Show Indexing Statistics" 실행
   - 각 타입별 chunk 수 확인

4. **재인덱싱**:
   - 문제가 발생하면 Tools → "Force Reindexing" 실행
   - 인덱싱 완료 후 다시 테스트

---

## 🔗 관련 문서

- `CHUNKING_OPTIMIZATION_REPORT.md`: Chunking 최적화 상세 보고서
- `SEND_SELECTION_TO_CHAT_REFACTORING.md`: Send Selection 기능 리팩토링 보고서

---

## ❓ 문제 발생 시

1. **콘솔 로그 확인**: 가장 먼저 확인할 사항
2. **인덱싱 상태 확인**: 인덱싱이 완료되었는지 확인
3. **재인덱싱 시도**: Tools → "Force Reindexing"
4. **이슈 리포트**: 문제가 지속되면 상세한 로그와 함께 리포트

